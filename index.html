<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Questionario sul funzionamento borderline</title>
  <meta name="description" content="Questionario sul funzionamento borderline: riflessione (ultime due settimane) su emozioni, relazioni e identit√†. Esito via e-mail, non diagnostico." />
  <style>
    :root{
      --bg:#0f172a;--panel:#0b1220;--muted:#94a3b8;--text:#e5e7eb;
      --accent:#22d3ee;--accent2:#a78bfa;--border:#1f2937;--focus:#60a5fa;
      --opt-bg:#0a0f1a; --opt-sel:#111b33; --shadow:0 10px 30px rgba(0,0,0,.35);
      --danger:#f43f5e; --success:#22c55e
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(1200px 600px at 20% -10%,#1e293b,transparent),
                 radial-gradient(900px 600px at 120% 10%,#1f2937,transparent),
                 var(--bg);
      color:var(--text);line-height:1.55
    }
    .container{max-width:980px;margin:0 auto;padding:24px}
    .hero{
      background:linear-gradient(135deg,#0b1220 0%,#0f172a 100%);
      border:1px solid var(--border);border-radius:20px;padding:28px;box-shadow:var(--shadow)
    }
    h1{font-size:clamp(1.55rem,1rem + 2.2vw,2.4rem);margin:0 0 10px}
    p{margin:0 0 10px}
    .progress{
      position:sticky;top:0;z-index:20;
      background:linear-gradient(180deg,rgba(15,23,42,.92),rgba(15,23,42,.85));
      backdrop-filter:blur(6px);
      border-bottom:1px solid var(--border)
    }
    .progress .bar-wrap{height:6px;background:#0a0f1a}
    .progress .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .35s ease}
    .progress .stats{display:flex;justify-content:space-between;align-items:center;gap:12px;font-size:.92rem;color:var(--muted);padding:8px 24px}
    .pct{font-variant-numeric:tabular-nums}
    form{margin-top:18px}
    .card{background:rgba(17,24,39,.65);border:1px solid var(--border);border-radius:16px;padding:18px;margin:14px 0;transition:border-color .2s, box-shadow .2s}
    .card.missing{border-color:var(--danger); box-shadow:0 0 0 2px rgba(244,63,94,.2), 0 8px 28px rgba(0,0,0,.35)}
    .q-title{font-weight:600;margin-bottom:12px}
    .scale{display:grid;grid-template-columns:repeat(5,minmax(120px,1fr));gap:12px}
    @media (max-width:720px){.scale{grid-template-columns:repeat(2,1fr)}}
    .opt{position:relative;border:1px solid var(--border);border-radius:14px;background:var(--opt-bg);
      padding:16px;text-align:center;cursor:pointer;box-shadow:0 1px 0 rgba(255,255,255,.03) inset}
    .opt .num{font-size:1.6rem;font-weight:800;letter-spacing:.5px}
    .opt .desc{display:block;margin-top:6px;font-size:.85rem;color:var(--muted)}
    .opt input[type=radio]{position:absolute;inset:0;opacity:0;cursor:pointer}
    .opt.selected{outline:2px solid var(--focus);outline-offset:2px;background:linear-gradient(180deg,var(--opt-sel),#0f172a)}
    .opt.selected .num{color:#e5e7eb}
    .opt.selected .desc{color:#cbd5e1}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin:18px 0 8px}
    button{appearance:none;border:1px solid var(--border);background:#0a0f1a;color:#e5e7eb;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    button.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1020;border:none}
    button:focus{outline:2px solid var(--focus);outline-offset:2px}
    .footer{color:#94a3b8;font-size:.9rem;margin-top:12px}
    .error{color:#fca5a5;margin-top:6px}
    .notice{margin-top:10px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);display:none}
    .notice.success{background:rgba(34,197,94,.08);color:#bbf7d0;border-color:rgba(34,197,94,.35)}
    .notice.error{background:rgba(244,63,94,.08);color:#fecaca;border-color:rgba(244,63,94,.35)}
    .wa-icon{width:18px;height:18px;vertical-align:middle;margin-left:6px}
    details.gdpr{border:1px solid var(--border);border-radius:12px;background:#0a0f1a;padding:12px 14px;margin-top:10px}
    details.gdpr summary{cursor:pointer;list-style:none;font-weight:600;color:#e5e7eb}
    details.gdpr summary::-webkit-details-marker{display:none}
    details.gdpr[open]{background:#0b1220}
    details.gdpr .gdpr-body{color:#94a3b8;margin-top:8px;font-size:.95rem}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 0}
    .pill{border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted);background:#0a0f1a;font-size:.9rem}
    @media print{
      .progress,.actions{display:none!important}
      body{background:#fff;color:#111}
      .card{break-inside:avoid}
      a{color:#111}
    }
  </style>
</head>
<body>
  <!-- Barra progresso -->
  <div class="progress" aria-hidden="true">
    <div class="stats container">
      <div><strong>Questionario</strong> ¬∑ 36 affermazioni ¬∑ Scala 1‚Äì5</div>
      <div id="counter" class="pct">0 / 36 risposte ¬∑ 0%</div>
    </div>
    <div class="bar-wrap" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Avanzamento">
      <div class="bar" id="bar"></div>
    </div>
  </div>

  <main class="container">
    <section class="hero">
      <h1>Questionario sul funzionamento borderline</h1>

      <p>Questo questionario esplora <strong>alcune aree chiave</strong> del tuo funzionamento emotivo e relazionale, le stesse che troverai descritte nel riepilogo che riceverai via e-mail.</p>

      <p>Si riferisce a come ti sei sentito nelle <strong>ultime due settimane</strong>, non all‚Äôintera vita.</p>

      <p>La compilazione richiede <strong>circa 5‚Äì7 minuti</strong>. Le risposte non devono essere perfette: √® sufficiente che siano sincere.</p>

      <p>Per ogni affermazione userai una scala da <strong>1 a 5</strong>:</p>
      <ul style="margin:0 0 10px 18px; padding:0; line-height:1.6">
        <li>1 = non succede mai</li>
        <li>2 = raramente</li>
        <li>3 = a volte</li>
        <li>4 = spesso</li>
        <li>5 = quasi sempre</li>
      </ul>

      <p>Alla fine, le risposte vengono raggruppate per area e si calcola una media per ciascuna. In base al punteggio, ogni area viene descritta come
        <em>area tranquilla</em>, <em>area sensibile</em> o <em>area reattiva</em>. Il risultato non √® una diagnosi, ma un punto di partenza per orientare il lavoro terapeutico.</p>

      <p>Al termine del questionario riceverai un <strong>riepilogo personalizzato via e-mail</strong> con delle indicazioni pratiche. In nessun caso le indicazioni si sostituiscono alla terapia.</p>

      <details class="gdpr">
        <summary>Informativa privacy (GDPR) <span aria-hidden="true" style="color:#94a3b8;font-weight:400">‚Äî clicca per leggere</span></summary>
        <div class="gdpr-body">
          I dati inseriti (risposte, nome, e-mail, consensi) sono trattati al solo scopo di inviarti il riepilogo
          e, se acconsenti, futuri contenuti professionali. I dati non hanno valore diagnostico.
          Sono conservati su sistemi Google (Foglio Google collegato) e non vengono ceduti a terzi.
          Puoi chiedere rettifica o cancellazione scrivendo a
          <a href="mailto:info@leonardobrazzoni.com" style="color:#22d3ee">info@leonardobrazzoni.com</a>.
        </div>
      </details>

      <!-- Email & consensi -->
      <div class="card" style="margin-top:14px">
        <div class="q-title">Ricevi il riepilogo via e-mail <span aria-hidden="true" title="obbligatorio" style="color:#fca5a5">*</span></div>
        <div style="display:grid; gap:10px">
          <label style="display:block">
            <span style="font-size:0.9rem;color:#94a3b8">Nome <span style="color:#fca5a5">*</span></span>
            <input id="nameInput" type="text" placeholder="Il tuo nome" aria-label="Nome" required style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0a0f1a;color:var(--text)" />
          </label>
          <label style="display:block">
            <span style="font-size:0.9rem;color:#94a3b8">E-mail <span style="color:#fca5a5">*</span></span>
            <input id="emailInput" type="email" inputmode="email" autocomplete="email" placeholder="nome@esempio.it" aria-describedby="emailHelp" required style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0a0f1a;color:#e5e7eb" />
          </label>
          <small id="emailHelp" style="color:#94a3b8">Usati solo per inviarti il riepilogo e, se acconsenti, contenuti professionali.</small>

          <label style="color:#94a3b8; display:flex; gap:8px; align-items:flex-start">
            <input id="consentResults" type="checkbox" required style="margin-top:4px" />
            <span>Acconsento a ricevere il <strong>riepilogo del questionario</strong> via e-mail. <span style="color:#fca5a5">*</span></span>
          </label>

          <fieldset style="border:none; padding:0; margin:0; color:#94a3b8">
            <legend style="font-size:0.95rem; color:#cbd5e1; margin-bottom:6px">
              Acconsenti a ricevere in futuro <strong>contenuti professionali</strong> (articoli, aggiornamenti)? <span style="color:#fca5a5">*</span>
            </legend>
            <div style="display:flex; gap:14px; align-items:center">
              <label style="display:flex; gap:6px; align-items:center">
                <input type="radio" name="consentMarketing" value="yes" required /> S√¨
              </label>
              <label style="display:flex; gap:6px; align-items:center">
                <input type="radio" name="consentMarketing" value="no" /> No
              </label>
            </div>
            <small style="display:block; margin-top:6px">
              Il consenso √® facoltativo e revocabile in qualsiasi momento (la domanda √® obbligatoria per inviare il riepilogo).
            </small>
          </fieldset>

          <label style="color:#94a3b8; display:flex; gap:8px; align-items:flex-start">
            <input id="adultCheckbox" type="checkbox" required style="margin-top:4px" />
            <span>Dichiaro di essere <strong>maggiorenne</strong> e di aver letto l‚Äôinformativa privacy. <span style="color:#fca5a5">*</span></span>
          </label>

          <div id="msg" class="error" aria-live="polite" role="status" tabindex="-1"></div>
          <div id="toast" class="notice" aria-live="assertive"></div>
        </div>
      </div>

      <div class="legend" aria-hidden="true">
        <span class="pill">1 = Non succede mai</span>
        <span class="pill">2 = Raramente</span>
        <span class="pill">3 = A volte</span>
        <span class="pill">4 = Spesso</span>
        <span class="pill">5 = Quasi sempre</span>
      </div>
    </section>

    <form id="form" novalidate></form>

    <section class="actions">
      <button type="button" class="primary" id="emailBtn">Invia e ricevi il risultato via email</button>
      <button type="button" id="resetBtn">Azzera risposte</button>
      <button type="button" id="printBtn">Stampa / Salva PDF</button>
    </section>

    <p class="footer">¬© <span id="year"></span> ‚Äì <strong>Dott. Leonardo Brazzoni</strong> ¬∑ Psicologo ¬∑
      <a href="https://leonardobrazzoni.com/" target="_blank" style="color:#22d3ee" rel="noopener">leonardobrazzoni.com</a> ¬∑
      <a href="https://wa.me/393290757193" target="_blank" rel="noopener" aria-label="WhatsApp">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" class="wa-icon" />
      </a>
      <br><span style="color:#94a3b8">Questo questionario non invia dati a server se non per l‚Äôinvio facoltativo via e-mail.</span>
    </p>
  </main>

  <script>
  const form = document.getElementById('form');
  const bar = document.getElementById('bar');
  const counter = document.getElementById('counter');
  const msg = document.getElementById('msg');
  const toast = document.getElementById('toast');
  const year = document.getElementById('year');
  if (year) { year.textContent = new Date().getFullYear(); }

  const emailBtn = document.getElementById('emailBtn');

  // ENDPOINT APPS SCRIPT
  const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzaQnFPONvFbLKiww3PyMgBTl-CGQalMH7O8Fru2L0SbSZOAPjXuBsXuelknWKNj3tkHA/exec';

  const ITEMS = [
    {text:"Ho paura che le persone importanti per me si allontanino o mi abbandonino.", reverse:false},
    {text:"Passo dal sentirmi molto vicino a qualcuno al sentirmi improvvisamente distante o deluso.", reverse:false},
    {text:"Non so bene chi sono o cosa voglio davvero.", reverse:false},
    {text:"Agisco d‚Äôimpulso senza pensare alle conseguenze (spese, cibo, sostanze, guida, sesso).", reverse:false},
    {text:"Riesco a fermarmi un attimo prima di reagire quando qualcosa mi fa arrabbiare.", reverse:true},
    {text:"Le mie emozioni cambiano rapidamente e sono molto intense.", reverse:false},
    {text:"Ho pensieri di farmi del male o metto in atto comportamenti autolesivi.", reverse:false},
    {text:"Sento un senso di vuoto o di mancanza di significato nella mia vita.", reverse:false},
    {text:"Anche quando cambio idea o umore, so chi sono e cosa voglio davvero.", reverse:true},
    {text:"Provo rabbia intensa e faccio fatica a controllarla.", reverse:false},
    {text:"Quando sono stressato/a mi sento distaccato/a da me stesso/a o dalla realt√†.", reverse:false},
    {text:"Sotto stress riesco comunque a restare lucido e concentrato su quello che sto facendo.", reverse:true},
    {text:"Tendo a interpretare gli atteggiamenti degli altri come critici o ostili nei miei confronti.", reverse:false},
    {text:"Oscillo tra desiderio di vicinanza e bisogno improvviso di allontanarmi.", reverse:false},
    {text:"Di solito riesco a sentirmi tranquillo anche se una persona importante non si fa sentire per un po‚Äô.", reverse:true},
    {text:"Dopo un conflitto rischio di fare qualcosa che mi danneggia o peggiora la situazione.", reverse:false},
    {text:"In mezzo agli altri mi perdo in pensieri come ‚Äúmi giudicano‚Äù o ‚Äúmi rifiuteranno‚Äù.", reverse:false},
    {text:"Durante una discussione riesco a esprimere cosa penso senza perdere il controllo.", reverse:true},
    {text:"Passo facilmente dall‚Äôidealizzare una persona al sentirla molto deludente.", reverse:false},
    {text:"Controllo messaggi, social o spostamenti degli altri per ridurre ansia o gelosia.", reverse:false},
    {text:"Provo vergogna che mi porta a sentirmi inadeguato/a o sbagliato/a.", reverse:false},
    {text:"Quando provo emozioni forti, riesco a capire cosa sto sentendo.", reverse:true},
    {text:"Il modo in cui mi vedo o ci√≤ che voglio cambia facilmente a seconda del contesto e questo mi crea disagio.", reverse:false},
    {text:"Dopo momenti di vicinanza temo di essere stato/a ‚Äútroppo‚Äù o di aver dato fastidio.", reverse:false},
    {text:"Se qualcuno non risponde o si allontana entro in allarme (paura, rabbia, gelosia).", reverse:false},
    {text:"Uso cibo, sostanze o attivit√† per spegnere emozioni che mi sembrano insopportabili.", reverse:false},
    {text:"Dopo periodi di forte autocontrollo finisco per perderlo all‚Äôimprovviso.", reverse:false},
    {text:"Metto alla prova la relazione per capire se l‚Äôaltra persona ci tiene davvero a me.", reverse:false},
    {text:"Dopo forte stress ho ricordi confusi o vuoti di memoria.", reverse:false},
    {text:"Durante i litigi alzo il tono o divento improvvisamente freddo/a e distante.", reverse:false},
    {text:"Mi √® difficile trovare equilibrio tra farmi rispettare e andare incontro agli altri.", reverse:false},
    {text:"Piccoli segnali (uno sguardo, un ritardo) cambiano drasticamente come mi sento nella relazione.", reverse:false},
    {text:"Dopo una crisi o una lite provo molta colpa o paura di aver rovinato tutto.", reverse:false},
    {text:"Quando non mi sento capito/a mi chiudo o interrompo i rapporti.", reverse:false},
    {text:"Mi √® difficile restare nel presente: rimugino sul passato o sul futuro.", reverse:false},
    {text:"Mi sento una persona diversa a seconda dell‚Äôemozione che provo e questo mi crea disagio.", reverse:false}
  ];

  const SCALE = [
    {value:1,label:'1',desc:'Non succede mai'},
    {value:2,label:'2',desc:'Raramente'},
    {value:3,label:'3',desc:'A volte'},
    {value:4,label:'4',desc:'Spesso'},
    {value:5,label:'5',desc:'Quasi sempre'}
  ];

  const STORAGE_KEY = 'q_er_values_v10';

  function showToast(text, type){
    if (!toast) return;
    toast.textContent = text;
    toast.className = 'notice ' + (type === 'error' ? 'error' : 'success');
    toast.style.display = 'block';
    setTimeout(function(){ toast.style.display = 'none'; }, 5000);
  }

  function getValues(){
    var values = [];
    for (var i = 1; i <= ITEMS.length; i++){
      var sel = form.querySelector('input[name="q' + i + '"]:checked');
      values.push(sel ? Number(sel.value) : null);
    }
    return values;
  }

  function setValues(values){
    values.forEach(function(v, i){
      if (v == null) return;
      var input = form.querySelector('input[name="q' + (i+1) + '"][value="' + v + '"]');
      if (input){
        input.checked = true;
        input.dispatchEvent(new Event('change'));
      }
    });
  }

  function updateProgress(){
    var vals = getValues();
    var done = vals.filter(function(v){ return v !== null; }).length;
    var pct = Math.round((done / ITEMS.length) * 100);
    if (bar) {
      bar.style.width = pct + '%';
      bar.parentElement.setAttribute('aria-valuenow', String(pct));
    }
    if (counter) {
      counter.textContent = done + ' / ' + ITEMS.length + ' risposte ¬∑ ' + pct + '%';
    }
  }

  function buildEmailSummary(){
    var vals = getValues();
    var miss = vals.filter(function(v){ return v == null; }).length;
    if (miss){
      throw new Error('Per ricevere i risultati devi rispondere a tutte le domande. Mancano ' + miss + ' risposta/e.');
    }
    var nameEl = document.getElementById('nameInput');
    var emailEl = document.getElementById('emailInput');
    var name = nameEl && nameEl.value ? nameEl.value.trim() : '';
    var email = emailEl && emailEl.value ? emailEl.value.trim() : '';
    var consentMarketingRadio = document.querySelector('input[name="consentMarketing"]:checked');
    var consentMarketing = consentMarketingRadio && consentMarketingRadio.value === 'yes';

    var saluto = name ? ('Ciao ' + name + ',') : 'Ciao,';
    var intro = saluto + '\n\n' +
      'grazie per aver completato il questionario sul funzionamento borderline.\n' +
      'Qui sotto trovi il tuo riepilogo personale, con una descrizione delle aree principali e alcune indicazioni pratiche ' +
      'per aiutarti a comprendere meglio i tuoi schemi relazionali ed emotivi.\n\n' +
      'Queste indicazioni non si sostituiscono a un percorso terapeutico, ma possono orientare la riflessione personale.\n\n' +
      'Un caro saluto,\n' +
      'Dott. Leonardo Brazzoni\n' +
      'Psicologo ‚Äì www.leonardobrazzoni.com\n' +
      'WhatsApp: https://wa.me/393290757193\n\n' +
      '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';

    var text = '';
    text += 'Questionario sul funzionamento borderline\n';
    text += 'Periodo di riferimento: ultime due settimane\n';
    text += 'Esito non diagnostico: analisi sintetica per aree utile a orientare il lavoro terapeutico.\n\n';

    text += '\nConsenso a contenuti futuri: ' + (consentMarketing ? 'S√å' : 'NO') + '\n';
    if (email) text += 'E-mail fornita: ' + email + '\n';

    return intro + text;
  }

  function validateEmail(email){
    var re = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
    return re.test(email);
  }

  function markMissing(){
    var vals = getValues();
    var firstMissingCard = null;
    vals.forEach(function(v, i){
      var card = form.querySelector('.card[data-q="' + (i+1) + '"]');
      if (card){
        if (v == null){
          card.classList.add('missing');
          if (!firstMissingCard) firstMissingCard = card;
        } else {
          card.classList.remove('missing');
        }
      }
    });
    if (firstMissingCard){
      firstMissingCard.scrollIntoView({behavior:'smooth', block:'center'});
    }
    return vals.filter(function(v){ return v == null; }).length;
  }

  function focusMsg(){
    if (!msg) return;
    msg.scrollIntoView({behavior:'smooth', block:'center'});
    try { msg.focus(); } catch(e){}
  }

  async function sendEmailResults(){
    if (!msg) return;
    msg.textContent = '';
    msg.style.color = '#fca5a5';

    var nameEl = document.getElementById('nameInput');
    var emailEl = document.getElementById('emailInput');
    var consentResultsEl = document.getElementById('consentResults');
    var consentMarketingEl = document.querySelector('input[name="consentMarketing"]:checked');
    var adultEl = document.getElementById('adultCheckbox');

    var name = nameEl && nameEl.value ? nameEl.value.trim() : '';
    var email = emailEl && emailEl.value ? emailEl.value.trim() : '';
    var consentResults = consentResultsEl && consentResultsEl.checked;
    var adult = adultEl && adultEl.checked;

    var missing = markMissing();
    if (missing){
      msg.textContent = 'Compila tutte le domande: mancano ' + missing + ' risposta/e.';
      focusMsg();
      return;
    }

    if (!name){
      msg.textContent = 'Inserisci il tuo nome.';
      focusMsg();
      return;
    }
    if (!email){
      msg.textContent = 'Inserisci la tua e-mail.';
      focusMsg();
      return;
    }
    if (!validateEmail(email)){
      msg.textContent = 'Inserisci un indirizzo e-mail valido.';
      focusMsg();
      return;
    }
    if (!consentResults){
      msg.textContent = 'Spunta il consenso per l‚Äôinvio del riepilogo.';
      focusMsg();
      return;
    }
    if (!consentMarketingEl){
      msg.textContent = 'Indica se desideri ricevere contenuti futuri (S√¨/No).';
      focusMsg();
      return;
    }
    if (!adult){
      msg.textContent = 'Dichiara di essere maggiorenne per procedere.';
      focusMsg();
      return;
    }

    var consentMarketing = consentMarketingEl.value === 'yes';

    var payload = {
      to: email,
      subject: 'Il tuo riepilogo ‚Äì Questionario sul funzionamento borderline',
      message: buildEmailSummary(),
      subscribe: !!consentMarketing,
      referenceWindow: 'ultime due settimane',
      answers: getValues().map(function(v, i){
        if (v == null) return null;
        return ITEMS[i].reverse ? 6 - v : v;
      }),
      answers_raw: getValues(),
      items: ITEMS.map(function(it){
        return {text: it.text, reverse: !!it.reverse};
      }),
      name: name
    };

    try {
      if (emailBtn) {
        emailBtn.disabled = true;
      }

      await fetch(GAS_ENDPOINT, {
        method: 'POST',
        mode: 'no-cors',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });

      // Mostra una pagina di conferma a schermo intero
      document.body.innerHTML = `
        <div style="
          min-height:100vh;
          display:flex;
          align-items:center;
          justify-content:center;
          background:#0f172a;
          font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
          color:#e5e7eb;
          margin:0;
        ">
          <div style="
            text-align:center;
            padding:24px 20px;
            border-radius:18px;
            background:#020617;
            border:1px solid #1f2937;
            max-width:420px;
            box-shadow:0 18px 40px rgba(0,0,0,0.45);
          ">
            <div style="font-size:2.8rem;margin-bottom:10px;">üì©</div>
            <div style="font-size:1.3rem;font-weight:600;margin-bottom:8px;">
              Email inviata
            </div>
            <p style="margin:0 0 4px 0;font-size:0.98rem;">
              Se non la trovi, controlla anche la cartella spam.
            </p>
          </div>
        </div>
      `;
    } catch (err) {
      console.error('ERRORE INVIO (rete):', err);
      msg.style.color = '#fca5a5';
      msg.textContent = 'Invio non riuscito. Controlla la connessione o riprova tra qualche minuto.';
      focusMsg();
      showToast('Errore durante l‚Äôinvio.', 'error');
      if (emailBtn) {
        emailBtn.disabled = false;
      }
    }
  }

  function persist(){
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(getValues()));
    } catch(e){}
  }

  function restore(){
    var raw;
    try {
      raw = localStorage.getItem(STORAGE_KEY);
    } catch(e){
      return;
    }
    if (!raw) return;
    try{
      var vals = JSON.parse(raw);
      if (Array.isArray(vals) && vals.length === ITEMS.length){
        setValues(vals);
      }
    } catch(e){}
  }

  function render(){
    ITEMS.forEach(function(item, idx){
      var card = document.createElement('fieldset');
      card.className = 'card';
      card.setAttribute('data-q', String(idx+1));

      var legend = document.createElement('legend');
      legend.className = 'q-title';
      legend.textContent = (idx+1) + '. ' + item.text;
      card.appendChild(legend);

      var scale = document.createElement('div');
      scale.className = 'scale';

      SCALE.forEach(function(opt){
        var label = document.createElement('label');
        label.className = 'opt';
        label.setAttribute('for', 'q' + (idx+1) + '_' + opt.value);

        var input = document.createElement('input');
        input.type = 'radio';
        input.name = 'q' + (idx+1);
        input.id = 'q' + (idx+1) + '_' + opt.value;
        input.value = String(opt.value);
        input.setAttribute('aria-label', opt.value + ' - ' + opt.desc);

        var num = document.createElement('div');
        num.className = 'num';
        num.textContent = String(opt.label);

        var desc = document.createElement('div');
        desc.className = 'desc';
        desc.textContent = opt.desc;

        label.appendChild(input);
        label.appendChild(num);
        label.appendChild(desc);
        scale.appendChild(label);

        input.addEventListener('change', function(){
          card.classList.remove('missing');
          var allOpts = scale.querySelectorAll('.opt');
          allOpts.forEach(function(o){ o.classList.remove('selected'); });
          label.classList.add('selected');
          updateProgress();
          persist();
        });
      });

      card.appendChild(scale);
      form.appendChild(card);
    });
  }

  if (emailBtn) {
    emailBtn.addEventListener('click', function(){ sendEmailResults(); });
  }
  var resetBtn = document.getElementById('resetBtn');
  if (resetBtn) {
    resetBtn.addEventListener('click', function(){
      form.reset();
      updateProgress();
      var cards = document.querySelectorAll('.card');
      cards.forEach(function(c){ c.classList.remove('missing'); });
      var opts = document.querySelectorAll('.opt');
      opts.forEach(function(o){ o.classList.remove('selected'); });
      try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
      showToast('Risposte azzerate.', 'success');
      if (emailBtn) {
        emailBtn.disabled = false;
      }
      if (msg) {
        msg.textContent = '';
      }
    });
  }
  var printBtn = document.getElementById('printBtn');
  if (printBtn) {
    printBtn.addEventListener('click', function(){ window.print(); });
  }

  render();
  restore();
  updateProgress();
  </script>
</body>
</html>
